# Testing Guide

This document describes the comprehensive test environment and test suite for the LDAP to OpenFGA sync script.

## Test Environment

The test environment uses Docker Compose to run:
- **OpenLDAP**: Pre-populated with test users and groups
- **OpenFGA**: Started fresh for each test scenario

## Quick Start

### 1. Start the test environment

```bash
./test.sh start
```

This will:
- Start OpenLDAP and OpenFGA containers
- Wait for services to be ready
- Load test data into LDAP

### 2. Run the test suite

```bash
./test.sh test
```

This will run all test scenarios and report results.

### 3. Stop the environment

```bash
./test.sh stop
```

## Test Management Script

The `test.sh` script provides convenient commands:

```bash
./test.sh start           # Start services
./test.sh stop            # Stop services
./test.sh restart         # Clean restart
./test.sh restart test    # Restart and run tests
./test.sh test            # Run test suite
./test.sh logs            # View service logs
./test.sh ldap            # Show LDAP data
./test.sh help            # Show help
```

## Test Data

### LDAP Users

The test LDAP contains 5 users:
- `alice@example.com` - Alice Smith
- `bob@example.com` - Bob Johnson
- `charlie@example.com` - Charlie Williams
- `dave@example.com` - Dave Brown
- `eve@example.com` - Eve Davis

### LDAP Groups

| Group | Members |
|-------|---------|
| developers | alice, bob |
| operations | charlie, dave |
| managers | alice |
| qa-team | eve |
| not-in-openfga | alice, bob |

The `not-in-openfga` group is intentionally not created in OpenFGA to test filtering.

## Test Scenarios

### Test 1: Initial Sync
**Goal**: Sync all memberships from LDAP to empty OpenFGA

**Setup**:
- OpenFGA: Groups exist, but no members
- LDAP: Groups with members

**Expected**: All LDAP memberships are added to OpenFGA

### Test 2: No Changes
**Goal**: Verify no changes when systems are in sync

**Setup**:
- OpenFGA: Correct memberships
- LDAP: Same memberships

**Expected**: No changes made

### Test 3: Additions
**Goal**: Add new members that exist in LDAP but not in OpenFGA

**Setup**:
- OpenFGA: Groups with partial memberships
- LDAP: Groups with complete memberships

**Expected**: Missing members are added

### Test 4: Deletions
**Goal**: Remove members that exist in OpenFGA but not in LDAP

**Setup**:
- OpenFGA: Groups with extra memberships
- LDAP: Groups with correct memberships

**Expected**: Extra members are removed

### Test 5: Mixed Changes
**Goal**: Handle both additions and deletions in one sync

**Setup**:
- OpenFGA: Some correct, some extra, some missing
- LDAP: Correct memberships

**Expected**: Extra members removed, missing members added

### Test 6: Group Filtering
**Goal**: Only sync groups that exist in OpenFGA

**Setup**:
- OpenFGA: Only some groups created
- LDAP: All groups including `not-in-openfga`

**Expected**: Only OpenFGA groups are synced, others are skipped

### Test 7: Different Group Members
**Goal**: Handle groups where LDAP and OpenFGA have different members

**Setup**:
- OpenFGA: qa-team with alice, bob, eve
- LDAP: qa-team with only eve

**Expected**: Only eve remains in OpenFGA

## Running Individual Tests

You can modify `test_suite.py` to run specific tests:

```python
# Comment out tests you don't want to run
# await runner.run_test("Initial sync", runner.test_initial_sync)
await runner.run_test("No changes", runner.test_no_changes)
# await runner.run_test("Additions", runner.test_additions)
```

## Manual Testing

### Connect to LDAP

```bash
# Search for all groups
docker compose exec ldap ldapsearch -x -H ldap://localhost \
  -b "ou=groups,dc=example,dc=com" \
  -D "cn=admin,dc=example,dc=com" \
  -w admin \
  "(objectClass=groupOfNames)"

# Search for all users
docker compose exec ldap ldapsearch -x -H ldap://localhost \
  -b "ou=users,dc=example,dc=com" \
  -D "cn=admin,dc=example,dc=com" \
  -w admin \
  "(objectClass=inetOrgPerson)"
```

### Query OpenFGA

```bash
# Get store ID (after tests have run)
STORE_ID=$(grep OPENFGA_STORE_ID .env.test | cut -d'=' -f2)

# Read all tuples
curl -s "http://localhost:8080/stores/${STORE_ID}/read" \
  -H "Content-Type: application/json" \
  -d '{}' | jq .

# Read only member relationships
curl -s "http://localhost:8080/stores/${STORE_ID}/read" \
  -H "Content-Type: application/json" \
  -d '{
    "tuple_key": {
      "relation": "member"
    }
  }' | jq .
```

## Test Environment Variables

The test suite uses `.env.test` with these settings:

```bash
LDAP_SERVER=ldap://localhost:389
LDAP_BIND_DN=cn=admin,dc=example,dc=com
LDAP_BIND_PASSWORD=admin
LDAP_GROUP_BASE_DN=ou=groups,dc=example,dc=com

OPENFGA_API_URL=http://localhost:8080
OPENFGA_STORE_ID=<auto-generated>
```

## Troubleshooting

### Services won't start

```bash
# Check if ports are already in use
lsof -i :389    # LDAP
lsof -i :8080   # OpenFGA

# View detailed logs
./test.sh logs
```

### Tests are failing

```bash
# Clean restart everything
./test.sh restart

# Run tests with more logging
python test_suite.py 2>&1 | tee test.log
```

### LDAP connection issues

```bash
# Test LDAP directly
docker compose exec ldap ldapsearch -x -H ldap://localhost \
  -b "dc=example,dc=com" \
  -D "cn=admin,dc=example,dc=com" \
  -w admin
```

### OpenFGA connection issues

```bash
# Check OpenFGA health
curl http://localhost:8080/healthz

# View OpenFGA logs
docker compose logs openfga
```

## CI/CD Integration

To run tests in CI/CD:

```yaml
# Example GitHub Actions workflow
name: Test
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install -r requirements.txt
      
      - name: Start services
        run: ./test.sh start
      
      - name: Run tests
        run: ./test.sh test
      
      - name: Stop services
        if: always()
        run: ./test.sh stop
```

## Adding New Tests

To add a new test scenario:

1. Add a method to the `TestRunner` class in `test_suite.py`:

```python
async def test_my_scenario(self):
    """Test description"""
    # Setup
    await self.env.clear_openfga_tuples()
    # ... setup code ...
    
    # Run sync
    await sync_ldap_to_openfga()
    
    # Verify
    actual = await self.env.get_openfga_memberships()
    assert actual == expected, "Error message"
```

2. Call it in the `main()` function:

```python
await runner.run_test("My scenario", runner.test_my_scenario)
```

## Test Output

Successful test run:

```
==========================================================
TEST: Initial sync from LDAP to empty OpenFGA
==========================================================
2024-11-22 12:00:00 - INFO - Starting LDAP to OpenFGA sync
...
âœ… PASSED: Initial sync from LDAP to empty OpenFGA

==========================================================
TEST SUMMARY
==========================================================
Total tests: 7
Passed: 7
Failed: 0
Success rate: 100.0%
==========================================================
```

## Performance Testing

For performance testing with larger datasets:

1. Modify the LDIF file to include more users/groups
2. Measure sync time:

```bash
time python sync.py
```

3. Profile the code:

```python
import cProfile
cProfile.run('asyncio.run(sync_ldap_to_openfga())', 'profile.stats')
```

## Cleanup

To completely remove all test data:

```bash
./test.sh stop
docker volume prune -f
rm .env.test
```

